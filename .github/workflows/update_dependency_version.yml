name: Extensions - Update Ballerina Version

on:
  workflow_dispatch:
    inputs:
      isRetrigger:
        description: 'Re-trigger a failed dependency bump workflow'
        required: false
        default: 'false'
      ballerinaVersion:
        description: 'Ballerina Version (Mandatory only when re-triggering failed workflow)'
        required: false
        default: ''
      autoMergePRs:
        description: 'Auto Merge PRs'
        required: false
        default: 'true'
      sendNotification:
        description: 'Send failure notification to Google Chat'
        required: false
        default: 'true'
  schedule:
    - cron: '30 6 * * *'

jobs:
  update-lang-version:
    name: Update Ballerina Lang Version
    if: github.repository_owner == 'ballerina-platform'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Install Python Packages
        run: |
          pip install requests
          pip install retry
          pip install PyGithub
          pip install httplib2

      - name: Update Ballerina Language Version
        run: |
          if ${IS_SCHEDULE_WORKFLOW} == true; then
            echo "Schedule Workflow Triggered"
            python dependabot/update_dependencies_in_pipeline.py "false" "" "true" "true" "schedule"
           else
             echo "Manual Trigger"
             python dependabot/update_dependencies_in_pipeline.py "${{ github.event.inputs.isRetrigger }}" \
                                                            "${{ github.event.inputs.ballerinaVersion }}" \
                                                            "${{ github.event.inputs.autoMergePRs }}" \
                                                            "${{ github.event.inputs.sendNotification }}"
           fi
        env:
          IS_SCHEDULE_WORKFLOW: ${{ github.event_name == 'schedule' }}
          BALLERINA_BOT_USERNAME: ${{ secrets.BALLERINA_BOT_USERNAME }}
          BALLERINA_BOT_TOKEN: ${{ secrets.BALLERINA_BOT_TOKEN }}
          BALLERINA_BOT_EMAIL: ${{ secrets.BALLERINA_BOT_EMAIL }}
          BALLERINA_REVIEWER_BOT_TOKEN: ${{ secrets.BALLERINA_REVIEWER_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.BALLERINA_CHAT_ID }}
          CHAT_KEY: ${{ secrets.BALLERINA_CHAT_KEY }}
          CHAT_TOKEN: ${{ secrets.BALLERINA_CHAT_TOKEN }}
          USER_ID_ANURUDDHA: ${{ secrets.USER_ID_ANURUDDHA }}
          USER_ID_BUDDHI: ${{ secrets.USER_ID_BUDDHI }}
          USER_ID_MADHUKA: ${{ secrets.USER_ID_MADHUKA }}
          USER_ID_KALAIYARASI: ${{ secrets.USER_ID_KALAIYARASI }}
          USER_ID_CHANANKA: ${{ secrets.USER_ID_CHANANKA }}
          USER_ID_MANINDA: ${{ secrets.USER_ID_MANINDA }}
          USER_ID_CHAMIL: ${{ secrets.USER_ID_CHAMIL }}
          USER_ID_ARSHIKA: ${{ secrets.USER_ID_ARSHIKA }}
          USER_ID_BHASHINEE: ${{ secrets.USER_ID_BHASHINEE }}
          USER_ID_ANJANA: ${{ secrets.USER_ID_ANJANA }}
          USER_ID_THISARU: ${{ secrets.USER_ID_THISARU }}
          USER_ID_DANESH: ${{ secrets.USER_ID_DANESH }}
          USER_ID_SUMUDU: ${{ secrets.USER_ID_SUMUDU }}
          USER_ID_GIMANTHA: ${{ secrets.USER_ID_GIMANTHA }}
          USER_ID_AYESH: ${{ secrets.USER_ID_AYESH }}
          USER_ID_DILAN: ${{ secrets.USER_ID_DILAN }}
          USER_ID_LAHIRU: ${{ secrets.USER_ID_LAHIRU }}
          USER_ID_KANEEL: ${{ secrets.USER_ID_KANEEL }}
          USER_ID_ALL: 'all'

      - name: Trigger Dashboard Update
        if: always()
        run: |
          curl -X POST \
          https://api.github.com/repos/ballerina-platform/ballerina-release/dispatches \
          -H 'Accept: application/vnd.github.v3+json' \
          -H 'Authorization: token ${{ secrets.BALLERINA_BOT_TOKEN }}' \
          --data "{
            \"event_type\": \"dashboard-update\",
            \"client_payload\": {
              \"sendNotification\": \"false\"
            }
          }"
